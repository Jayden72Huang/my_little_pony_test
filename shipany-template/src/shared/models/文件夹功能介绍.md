# Models 目录说明

## 目录功能
数据模型层（Model Layer）/ 数据访问层（Data Access Layer）

## 目录目的
集中管理所有与数据库交互的业务逻辑，提供统一的数据访问接口，实现业务逻辑与视图层的分离

## 文件列表

### 用户与认证相关
- **user.ts** - 用户管理
  - 功能：用户的增删改查、用户信息验证
  - 目的：管理用户账户数据和用户相关操作

- **apikey.ts** - API 密钥管理
  - 功能：生成、验证、管理用户的 API 密钥
  - 目的：为用户提供 API 访问凭证管理

### AI 功能相关
- **ai_task.ts** - AI 任务管理
  - 功能：创建、查询、更新 AI 生成任务，处理积分消耗和退还
  - 目的：管理 AI 内容生成任务的完整生命周期

- **chat.ts** - 聊天会话管理
  - 功能：创建、查询聊天会话
  - 目的：管理用户的对话会话数据

- **chat_message.ts** - 聊天消息管理
  - 功能：存储、查询聊天消息记录
  - 目的：管理会话中的消息历史

### 计费与订阅相关
- **credit.ts** - 积分/信用管理
  - 功能：积分充值、消耗、查询余额
  - 目的：管理用户的积分系统和消费记录

- **order.ts** - 订单管理
  - 功能：创建、查询、更新订单状态
  - 目的：处理用户的购买订单流程

- **subscription.ts** - 订阅管理
  - 功能：创建、更新、查询用户订阅状态
  - 目的：管理用户的订阅服务和周期

### 内容管理相关
- **post.tsx** - 文章/内容管理
  - 功能：查询、解析 MDX 文件，获取博客文章和静态页面
  - 目的：管理网站的内容数据（博客、静态页面等）

- **taxonomy.ts** - 分类/标签管理
  - 功能：管理内容的分类和标签体系
  - 目的：为内容提供组织和分类功能

### 系统配置
- **config.ts** - 配置管理
  - 功能：存储和读取系统配置项
  - 目的：管理应用的动态配置数据

## 架构说明

### 设计模式
采用经典的 **MVC 架构**中的 **Model 层**设计

### 每个 Model 文件通常包含：

1. **类型定义**
   ```typescript
   export type Entity = typeof entityTable.$inferSelect;
   export type NewEntity = typeof entityTable.$inferInsert;
   export type UpdateEntity = Partial<NewEntity>;
   ```

2. **CRUD 操作函数**
   - `createXxx()` - 创建记录
   - `findXxxById()` - 查询单条记录
   - `getXxxs()` - 查询列表
   - `updateXxxById()` - 更新记录
   - `deleteXxxById()` - 删除记录

3. **业务逻辑**
   - 事务处理
   - 数据验证
   - 关联查询
   - 复杂业务规则

### 技术栈
- **ORM**: Drizzle ORM
- **数据库**: PostgreSQL（可切换至 MySQL/SQLite）
- **类型安全**: TypeScript 类型推导

## 使用示例

```typescript
// 在 API 路由或 Server Component 中使用
import { createAITask, getAITasks } from '@/shared/models/ai_task';
import { findUserById } from '@/shared/models/user';

// 创建任务
const task = await createAITask({
  userId: 'user-123',
  scene: 'image-generation',
  mediaType: 'image',
  costCredits: 10
});

// 查询任务列表
const tasks = await getAITasks({
  userId: 'user-123',
  status: 'completed',
  page: 1,
  limit: 20
});
```

## 架构优势

✅ **分层清晰** - 数据库操作集中管理，业务逻辑与视图分离
✅ **可复用性** - 函数可在 API、Server Components、Server Actions 中复用
✅ **易维护** - 修改数据操作只需修改对应 model 文件
✅ **类型安全** - TypeScript 和 Drizzle ORM 确保编译时类型检查
✅ **统一规范** - 所有数据访问遵循一致的命名和结构规范

## 注意事项

- 所有数据库操作应通过 model 层函数进行，避免在视图层直接操作数据库
- 涉及多表操作时使用事务（transaction）确保数据一致性
- 复杂查询应在 model 层封装，保持接口简洁
- 敏感数据操作需添加权限验证和数据脱敏
